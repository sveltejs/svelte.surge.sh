<svelte:head>
	<title>Learn Svelte</title>
</svelte:head>

<div ref:container class='content'>
	{#each sections as section}
	<section id='{section.slug}'>
		<h2>
			{section.metadata.title}
			<small>
				<a href='https://github.com/sveltejs/svelte.technology/edit/master/content/guide/{section.file}' title='edit this section'>
					<Icon clas='prime' name='edit' /></a>
			</small>
		</h2>
		{@html section.html}
	</section>
	{/each}
</div>

<div class='sidebar'>
	<GuideContents ref:contents/>
</div>

<style>
	.sidebar {
	  position: fixed;
	  top: 4rem;
	  left: var(--page-side);
	  width: var(--sidebar);
	  height: calc(100vh - 4rem);
	  display: none;
	  font-family: var(--font-ui);
	  overflow-y: auto;
	}

	.content {
	  /* width: calc(100% - var(--page-side)); */
	  /* padding: 0 0 0 calc(var(--page-side) + var(--sidebar)); */
	  padding-left: calc(var(--page-side) + var(--sidebar));
	  /* padding: 1em; */
	  tab-size: 2;
	}

	/* icon needs :hover */
	small {
	  font-size: var(--h5);
	  float: right;
	  pointer-events: all;
	  cursor: pointer;
	}

	section :global(blockquote) {
	  color: var(--second);
	  border: var(--border-w) solid currentColor;
	  padding-left: 11%;
	}

	section :global(blockquote::before) {
	  content: 'de';
	  position: absolute;
	  /* transform: translate(8%, 50%); */
	  float: left;
	  color: var(--prime);
	  width: 1em;
	  height: 1em;

	  background-image: url('');
	}

	@media (min-width: 768px) {
	  .sidebar {
	    display: block;
	  }
	}
</style>

<script>
	export default {
		components: {
			GuideContents: '../../components/guide-contents.html',
			Icon: '../../components/icon.html',
		},

		preload() {
			return this.fetch(`api/guide`).then(r => r.json()).then(sections => {
				return { sections };
			});
		},

		oncreate() {
			const anchors = this.refs.container.querySelectorAll('[id]');
			let positions;

			const onresize = () => {
				const { top } = this.refs.container.getBoundingClientRect();
				positions = [].map.call(anchors, anchor => {
					return anchor.getBoundingClientRect().top - top;
				});
			}

			let lastId = window.location.hash.slice(1);

			const onscroll = () => {
				const top = -window.scrollY;

				let i = anchors.length;
				while (i--) {
					if (positions[i] + top < 40) {
						const anchor = anchors[i];
						const { id } = anchor;

						if (id !== lastId) {
							this.store.set({ activeGuideSection: id });
							this.fire('scroll', id);

							lastId = id;
						}

						return;
					}
				}
			};

			window.addEventListener('scroll', onscroll, true);
			window.addEventListener('resize', onresize, true);

			// wait for fonts to load...
			const timeouts = [
				setTimeout(onresize, 1000),
				setTimeout(onresize, 5000)
			];

			this.on('destroy', () => {
				window.removeEventListener('scroll', onscroll, true);
				window.removeEventListener('resize', onresize, true);

				timeouts.forEach(timeout => clearTimeout(timeout));
			});

			onresize();
			onscroll();
		}
	};
</script>