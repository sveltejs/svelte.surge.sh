<script>
	// [svelte-upgrade suggestion]
	// manually refactor all references to __this
	const __this = {
		get: () => ({ i, undoStack, circles, selected, adjusting, adjusted })
	};

	export let i = 0;
	export let undoStack = [[]];
	export let circles = [];
	export let selected;
	export let adjusting = false;
	export let adjusted = false;

	// [svelte-upgrade suggestion]
	// review these functions and remove unnecessary 'export' keywords
	export function handleClick(event) {
		if (__this.get().adjusting) {
			adjusting = false;

			// if nothing changed, rewind
			if (__this.get().adjusted) push();
			return;
		}

		const circle = {
			cx: event.clientX,
			cy: event.clientY,
			r: 50
		};

		const circles = __this.get().circles;
		circles.push(circle);
		circles = circles, selected = circle;

		push();
	}

	export function adjust(event) {
		event.preventDefault();
		if (!__this.get().selected) return;
		adjusting = true, adjusted = false;
	}

	export function select(circle, event) {
		if (!__this.get().adjusting) {
			event.stopPropagation();
			selected = circle;
		}
	}

	export function push() {
		undoStack.splice(++i);
		undoStack.push(clone(circles));
		i = i, undoStack = undoStack;
	}

	export function travel(d) {
		const circles = clone(undoStack[i += d]);
		circles = circles, i = i, adjusting = false;
	}

	function clone(circles) {
		return circles.map(({ cx, cy, r }) => ({ cx, cy, r }));
	}
</script>

<!--
https://github.com/eugenkiss/7guis/wiki#circle-drawer

Click on the canvas to draw a circle. Click on a circle
to select it. Right-click on the canvas to adjust the
radius of the selected circle.
-->

<div class='controls'>
	<button on:click='{() => travel(-1)}' disabled='{i === 0}'>undo</button>
	<button on:click='{() => travel(+1)}' disabled='{i === undoStack.length -1}'>redo</button>
</div>

<svg on:click='{handleClick}' on:contextmenu='{adjust}'>
	{#each circles as circle}
		<circle cx='{circle.cx}' cy='{circle.cy}' r='{circle.r}'
			on:click='{event => select(circle, event)}'
			fill='{circle === selected ? "#ccc": "white"}'
		/>
	{/each}
</svg>

{#if adjusting}
	<div class='adjuster'>
		<p>adjust diameter of circle at {selected.cx}, {selected.cy}</p>
		<input type='range' bind:value='selected.r' on:input='{() => adjusted = true}'>
	</div>
{/if}

<style>
	.controls {
		position: absolute;
		width: 100%;
		text-align: center;
	}

	svg {
		background-color: #eee;
		width: 100%;
		height: 100%;
	}

	circle {
		stroke: black;
	}

	.adjuster {
		position: absolute;
		width: 80%;
		top: 50%;
		left: 50%;
		transform: translate(-50%,-50%);
		padding: 1em;
		text-align: center;
		background-color: rgba(255,255,255,0.5);
	}

	input[type='range'] {
		width: 100%;
	}
</style>